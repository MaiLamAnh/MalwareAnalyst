<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVE-2023-38831</title>
    <style>
        body {
            font-family: "Anonymous Pro", monospace;
            margin: 0;
            padding: 0;
            background-color: #333;
            color:#32CD32;
        }

        header {
            background-color: #333;
            color: #fff;
            text-align: center;
            padding: 20px;

            color:#32CD32;
        }

        h1 {
            margin-top: 0;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #333;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);


        }

        h2 {
            font-size: 24px;
            margin-top: 0;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }
        a{
            color:#32CD32;
        }

        li {
            margin-bottom: 10px;
        }
        img {
            width: 100%; /* Đặt chiều rộng */
         /*  / /* Bo góc hình ảnh (tuỳ chọn) */
        }
        footer {
    text-align: center;
    background-color: #302828;
     color:#32CD32;
    padding: 10px;
    margin-top: 20px;
}
    </style>
</head>
<body>
    <header>
        <h1>Mai Lam Anh Cybers3c - CVE Analyst</h1>
    </header>

    <div class="container">

        <h2>Phân tích CVE-2023-38831 - Lỗ hổng bảo mật WinRAR đã bị khai thác</h2>
        
        
        
        <ul>
            <li><a href="#section1">Giới thiệu về lỗ hổng bảo mật WinRAR</a></li>
            <li><a href="#section2">Lỗ hổng hoạt động như thế nào?</a></li>
            <li><a href="#section4">Kịch bản khai thác CVE</a></li>
            <ul>
                <li><a href="#kichban">--->Kịch bản khai thác</a></li>
                <li><a href="#whathappen">--->What's happened?? </a></li>
                <li><a href="#VulSample">--->Phân tích a Vulnerable sample</a></li>
            </ul>
            <li><a href="#section3">Kết luận</a></li>
        </ul>

        <section id="section1">
            <h2>Giới thiệu về lỗ hổng bảo mật WinRAR</h2>
            <img src="./../images/CVE-2023-38831.PNG">
            <p>Kể từ tháng 04/2023, theo tiết lộ của Group-IB, một lỗ hổng bảo mật được vá gần đây trong phần mềm lưu trữ WinRAR phổ biến đã bị khai thác dưới dạng zero-day. Lỗ hổng này có mã định danh CVE-2023-38831, cho phép các tác nhân đe dọa giả mạo phần mở rộng của tệp, do đó có thể khởi chạy các tập lệnh (script) độc hại có trong tệp nén giả mạo dưới dạng tệp hình ảnh hoặc tệp văn bản có vẻ vô hại. Theo WuBlockchain, nhóm hacker Tiều Tiên khét tiếng Konni, đã lần đầu tiên tận dụng lỗ hổng của WinRAR (CVE-2023-38831) để tiến hành cuộc tấn công vào ngành công nghiệp tiền điện tử, do đó, <a href="https://allinstation.com/trader-crypto-gap-nguy-hiem-vi-lo-hong-bao-mat-cua-winrar/"> Trader Crypto gặp nguy hiểm vì lỗ hổng bảo mật của WinRAR.</a></p>
            <img src="./../images/CVE-2023-38831-2.PNG"> 

        </section>

        <section id="section2">
            <p> </p>
            <h2>Lỗ hổng hoạt động như thế nào?</h2>

            <p>Trong hệ điều hành Windows, nguyên tắc cơ bản là không thể có hai tệp hoặc thư mục có cùng tên trong cùng một thư mục. Tuy nhiên, một trường hợp đặc biệt là bạn có thể tạo ra tình huống này trong các phần mềm nén như WinRar hoặc 7-Zip. Trong các tệp nén, có một cơ chế đặc biệt cho phép bạn lưu trữ nhiều objects (bao gồm cả tệp và thư mục) có tên giống nhau mà không gây xung đột. Cơ chế này sử dụng một cấu trúc đặc biệt trong tệp nén để quản lý các tên objects duy nhất. Nhờ vậy, bạn có thể có hai objects (tệp hoặc thư mục) có cùng tên một cách hợp pháp trong một tệp ZIP hoặc RAR mà không gặp vấn đề về trùng tên.</p>
            
            <p>Khi bạn sở hữu một tệp và một thư mục mang cùng tên trong một tệp nén và muốn truy cập tệp một cách tạm thời bằng cách nhấp đúp vào nó trong giao diện tệp nén, WinRAR sẽ tự động giải nén tệp này và trích xuất toàn bộ các tệp có cùng tên với tệp mục tiêu. Những tệp này sẽ được lưu trong một thư mục tạm thời được đặt tại %tmp%. Mình đã thử điều đó trên WinRAR, nhưng kết quả có thể khác nhau trên 7-Zip. Do đó, bạn nên kiểm tra kỹ trường hợp này bằng cách thực hiện thao tác thủ công. Trong thực tế, bạn không thể đặt hai đối tượng có cùng tên trong một tệp nén sử dụng WinRAR, và trong trường hợp này, mình đã sử dụng 7-Zip để tạo tệp nén. </p>
            
        </section>
        <section id="section4">
            <h2 >Kịch bản khai thác CVE </h2>
            <h4 id="kichban">Kịch Bản khai thác:</h4>
            <p>Mình tạo một thư mục tên là “ClickZoBayAcc”, trong thư mục này có 2 tệp: Ahihi1.txt và Ahihi2.txt. Trong đó, nội dung của các tập tin này là khác nhau:</p>
            
            <img src="./../images/CVE-2023-38831-3.PNG">
            <p>Mình mở cmd và chạy lệnh: ""C:\Program Files\7-Zip\7z.exe" a target.zip Ahihi1.txt" để nén file Ahihi1.txt với tệp nén có tên target.zip</p>
            <img src="./../images/CVE-2023-38831-4.PNG">
            <p>Tiếp tục chạy lệnh: ""C:\Program Files\7-Zip\7z.exe" a target.zip Ahihi2.txt" để nén file Ahihi2.txt vào tệp nén target.zip luôn nè.</p>
             <img src="./../images/CVE-2023-38831-5.PNG">
            <h4 id="dump">Dump thử process liên quan</h4>
            <p>Bây giờ mình có một tệp lưu trữ chứa hai tệp: Ahihi1.txt và Ahihi2.txt </p>
            <img src="./../images/CVE-2023-38831-6.PNG">
            <p>Bây giờ nếu như bạn muốn thay đổi tên file Ahihi2.txt thành Ahihi1.txt thì sẽ như thế nào? Như nãy mình có chia sẽ rằng trong hệ điều hành không cho phép 2 tệp cùng tên tồn tại song song cùng một thời điểm, ở đây mình sẽ làm điều đó mà sử dụng 7-zip.</p>
            <p>Chạy lệnh:""C:\Program Files\7-Zip\7z.exe" rn target.zip Ahihi2.txt Ahihi1.txt" để thay đổi tên của file Ahihi2.txt thành Ahihi1.txt.
            <img src="./../images/CVE-2023-38831-8.PNG">
            
            <p>Kết quả nè:</p>
            <img src="./../images/CVE-2023-38831-9.PNG">
            <p>Đây là nội dung của Ahihi1.txt và Ahihi2.txt trước khi mình thực hiện thay đổi cho cùng tên. </p>
            <img src="./../images/CVE-2023-38831-11.PNG">
            <p>Bây giờ hãy mở một trong những tệp văn bản này từ tệp lưu trữ và xem điều gì sẽ xảy ra!</p>
            <img src="./../images/CVE-2023-38831-10.PNG">
            
            <p>Như bạn thấy khi mình mở cái đầu tiên, Winrar hiển thị cho mình lời nhắc thay thế một tập tin. sau đó, tôi nhấp vào Có và nó mở cho mình tệp Ahihi1.txt thứ hai.</p>
            <img src="./../images/CVE-2023-38831-12.PNG">
            <h4 id="whathappen">What's happened??</h4>
            <p>Trong quá trình giải nén bằng WinRAR, chương trình tạo một thư mục tạm thời trong thư mục tạm thời của hệ thống và sau đó bắt đầu quá trình giải nén. Đầu tiên, nó giải nén tệp tin đầu tiên (Ahihi1.txt) và đặt chúng trong thư mục tạm thời (%temp). Khi quá trình giải nén tệp tin thứ hai (Ahihi2.txt) bắt đầu, WinRAR phát hiện rằng tên của tệp tin này trùng với tên của tệp tin đầu tiên trong cùng thư mục tạm thời. Trong hệ điều hành Windows, không thể có hai tệp tin có cùng tên trong cùng một thư mục, vì vậy WinRAR hiển thị một thông báo hỏi bạn có muốn ghi đè lên tệp tin đầu tiên hay không. Nếu bạn đồng ý, tệp tin thứ hai sẽ ghi đè lên tệp tin đầu tiên và nội dung của tệp tin đầu tiên sẽ bị thay thế bởi nội dung của tệp tin thứ hai.</p>

            <p>Khi bạn kiểm tra tương tự với 7-Zip, 7-Zip chỉ giải nén tệp tin mà bạn muốn mở, không thay đổi nội dung của bất kỳ tệp tin nào khác.</p>

            <p>Lý do của hành vi này của WinRAR có thể liên quan đến cách chương trình xử lý tên tệp tin và quản lý trùng tên trong quá trình giải nén.</p>
            <p>Winrar sẽ có  hàm kiểm tra tên của hai tệp theo từng ký tự để xác định xem chúng có trùng nhau không. Trong ví dụ này, mình có hai tệp có tên giống nhau, cả hai đều có tên là "Ahihi1.txt".</p>

            <p>Trong tệp lưu trữ, chúng ta có nhiều tệp khác nhau. Khi bạn muốn tạm thời trích xuất một tệp từ đó, WinRAR sẽ so sánh tên của tệp đó với tất cả các tên của các đối tượng trong kho lưu trữ. Ví dụ, nếu có năm tệp trong kho lưu trữ và bạn muốn giải nén một trong số chúng, WinRAR sẽ kiểm tra tên của tệp đó với tên của tất cả bốn tệp còn lại trong kho lưu trữ để xác định tệp cần được giải nén.</p>
            <p>Nếu tên của các tệp này trùng nhau, hàm sẽ thực hiện một kiểm tra khác.</p>

            <p>Để hiểu rõ hơn, hãy xem xét tình huống sau: Chúng ta muốn giải nén tệp "Ahihi1" và trong kho lưu trữ, chúng ta có một tệp khác có tên là "Ahihi2" nằm "data" Trong thư mục "data" chúng ta cũng có một tệp khác có tên "Ahihi3"

            Khi bạn thực hiện việc giải nén "Ahihi1" bằng cách nhấp vào nó, WinRAR sẽ kiểm tra xem tên của "Ahihi1" có trùng với tên của bất kỳ tệp hoặc thư mục nào khác không trong kho lưu trữ. Nếu có bất kỳ tên tệp nào khớp với tên "Ahihi1" nó sẽ được thêm vào danh sách giải nén. Ngoài ra, nếu tên của thư mục trùng với tên "Ahihi1" WinRAR sẽ kiểm tra các tệp trong thư mục đó có tên là "Ahihi1" hay không. Nếu có bất kỳ tệp nào khớp, chúng sẽ cũng được thêm vào danh sách giải nén. Đoạn code dưới đây sẽ làm rõ quá trình kiểm tra này cho bạn:</p>
            <img src="./../images/CVE-2023-38831-13.PNG">
            <p>Điều này cho phép WinRAR tự động xác định và giải nén các tệp có tên giống nhau hoặc cùng tên với "fileA" mà bạn muốn giải nén.</p>
            <h4 id="VulSample">Phân tích a Vulnerable sample</h4>
            <p>Hãy cùng phân tích một mẫu vulnerable sample.</p>
            <p>Trong ví dụ này, chúng ta thấy một tệp có tên "Hacker.txt ", và ở cuối tên của nó có một khoảng trắng (space).
            <p>Bên cạnh đó, chúng ta còn có một thư mục có cùng tên với tệp trên, và tên của thư mục cũng kết thúc bằng một khoảng trắng (space).</p>
            <p>Trong thư mục đó, chúng ta phát hiện một tệp khác, cũng mang tên giống với tệp đầu tiên và có một khoảng trắng ở cuối tên, và sau đó là phần mở rộng ".cmd". Đoạn mã trong tệp này chứa payload tấn công.</p>
            <p>Bây giờ, khi Winrar cố gắng giải nén các tệp trên, tệp đầu tiên sẽ được xem xét là mục tiêu của quá trình giải nén (được nhấp vào để thực hiện giải nén và mở). Một điểm quan trọng cần lưu ý là Windows sẽ tự động loại bỏ bất kỳ khoảng trắng nào ở đầu và cuối của tên tệp khi nó cố gắng tạo tệp mới, như đã được mô tả trên trang web của Microsoft về vấn đề <a href="https://learn.microsoft.com/en-us/troubleshoot/windows-client/shell-experience/file-folder-name-whitespace-characters" >Support for Whitespace characters in File and Folder names for Windows </a>.</p>
            <p>Mình tạo theo ví dụ trên:</p>
            <img src="./../images/CVE-2023-38831-17.PNG">
            <p>Bây giờ chúng ta có một thư mục tạm thời như thế này:</p>
            <img src="./../images/CVE-2023-38831-18.PNG">
            <img src="./../images/CVE-2023-38831-19.PNG">
            <p>Winrar thử kiểm tra xem chuỗi đường dẫn của tệp "Hacker.txt" có kết thúc bằng ký tự khoảng trắng (0x20) không? Nếu có, nó sẽ thay thế ký tự khoảng trắng đó bằng một giá trị NULL (0x00). Kết quả là sau bước kiểm tra này, tên tệp sẽ không còn ký tự khoảng trắng ở cuối nữa, chỉ còn lại "Hacker.txt".</p>
            <p>Tuy Winrar rất mạnh mẽ, nhưng nó không thể tự hiểu cách mở một tệp cụ thể. Ví dụ, nếu bạn có một tệp PDF, Winrar không thể tự động biết cần dùng ứng dụng gì để mở tệp đó. Điều này cũng áp dụng cho các tệp văn bản khác trên hệ điều hành Windows. Trong những tình huống như vậy, Winrar sử dụng API Windows (ShellExecute) để mở tệp bằng ứng dụng mặc định được liên kết với loại tệp đó.</p>
            <p> Các bạn có thể tìm hiểu thêm ShellExecuteExW từ Microsoft site <a href="https://learn.microsoft.com/en-us/windows/win32/api/shellapi/nf-shellapi-shellexecuteexw">ShellExecuteExW function</a> </p>
            <p>Winrar đã loại bỏ khoảng trắng từ tên tệp khi ghi dữ liệu, nhưng nó đã quên cập nhật thay đổi này trong extraction list. Do đó, tên tệp đích vẫn giữ nguyên và vẫn chứa khoảng trắng.</p>

            <p>Lúc này, khi đường dẫn của tệp này được chuyển đến hàm API ShellExecuteExA để mở, nó sẽ trông như sau: "C:\Users\Laman\AppData\Local\Temp\Rar$DIa9580.46514\Hacker.txt ". Nhưng trong thư mục "tmp", chúng ta có các tệp như sau:"</p>
            <p>“C:\Users\sik\AppData\Loca\Temp\Rar$DIa9580.46514\Hacker.txt” –> Không có khoảng trắng</p>
            <p>“C:\Users\sik\AppData\Loca\Temp\Rar$DIa9580.46514\Hacker.txt .cmd“</p>
            <p> Vậy kết quả chúng ta thu được là chúng ta không có tệp có tên “Hacker.txt ” nhưng ShellExecuteExA mở “Hacker.txt .cmd”</p>
            <p>Chúng ta sẽ có ví dụ nho nhỏ để thấy được thật sự CVE này có như những gì chúng ta chứng minh hay không? Trong một thư mục trong Windows, mình đã tạo một tệp .bat đơn giản và đặt tên là “Test .bat” để khởi chạy “notepad.exe”. Mình chỉ đặt một khoảng trắng giữa phần mở rộng và tên. Sau đó, mở cửa sổ “Run” và đặt đường dẫn đầy đủ của tệp .bat vào khoảng trống nhưng không có phần mở rộng “.bat” và chạy nó. Tệp .bat đã được thực thi thành công.</p>
            <img src="./../images/CVE-2023-38831-20.PNG">
            <img src="./../images/CVE-2023-38831-21.PNG">


        </section>
        <section id="section3">
            <h2>Kết luận</h2>
            <p>Mình đã tìm hiểu rất nhiều nguồn tham khảo để viết về bài phân tích này, mình được biết hiện tại có rất nhiều hacker đang tận dụng lỗ hỏng này để tấn công/khai thác. Việc mình cần làm lúc này là update bản vá Winrar, nếu ShellExecuteExA xem xét đường dẫn đầy đủ của tệp thì sự cố sẽ không xảy ra và lỗi này không được chuyển thành CVE đâu nhỉ :D.</p>
        </section>

    </div>
    <footer>
        <p>&copy; 2023 Mai Lam Anh CyberS3c</p>
    </footer>
</body>
</html>
