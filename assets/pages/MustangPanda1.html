<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mustang Panda 01</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        header {
            background-color: #333;
            color: #fff;
            text-align: center;
            padding: 20px;
        }

        h1 {
            margin-top: 0;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            font-size: 24px;
            margin-top: 0;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            margin-bottom: 10px;
        }
        img {
            width: 100%; /* Đặt chiều rộng */
         /*  / /* Bo góc hình ảnh (tuỳ chọn) */
        }
        footer {
    text-align: center;
    background-color: #302828;
    color: #fff;
    padding: 10px;
    margin-top: 20px;
}
    </style>
</head>
<body>
    <header>
        <h1>Mai Lam Anh Cybers3c - Malware Analyst</h1>
    </header>

    <div class="container">

        <h2>Phân tích mẫu malware Mustang Panda 843709a59f12ff7aa06a5837be7a1a93fdf6f02f99936af6658c166e8abcaa2d</h2>
        
        
        
        <ul>
            <li><a href="#section1">Phân loại ban đầu</a></li>
            <ul>
                <li><a href="#filename">--->File name</a></li>
                <li><a href="#VT">--->Tỷ lệ phát hiện chống Anti-Virus</a></li>
                <li><a href="#resource">--->Tài nguyên </a></li>
                <li><a href="#sections">--->Sections trong file thực thi (PE file)</a></li>
                <li><a href="#imports">--->Imports</a></li>
            </ul>
            
            <li><a href="#section2">Phân tích tĩnh</a></li>
            <ul>
                <li><a href="#plugxe">--->PlugX là gì?</a></li>
                <li><a href="#technical">--->Phân tích kỹ thuật </a></li>
            </ul>
            <li><a href="#section4">Phân tích động</a></li>
            <ul>
                <li><a href="#behavior">--->Phân tích hành vi</a></li>
                <li><a href="#dump">--->Dump thử một số process </a></li>
                <li><a href="#why">--->Làm sao để tồn tại?</a></li>
            </ul>
            <li><a href="#section3">Kết luận</a></li>
        </ul>

        <section id="section1">
            <h2>Phân loại ban đầu</h2>
            <h4 id="filename">File Name</h4>
            <p>Service Log.rar</p>
            <img src="./../images/Mustang-1.1.PNG">
            <p>MD5: 1a5aee6e33385b69b7ca46229fb64b8b</p>
            <p>SHA-1: 7535bff2f6ae94157f7004ff770ea28b3600c962</p>
            <p>SHA-256: 843709a59f12ff7aa06a5837be7a1a93fdf6f02f99936af6658c166e8abcaa2d</p>
            <h4 id="VT">Tỷ lệ phát hiện chống Anti-Virus (39/60) </h4>
            <p>Tại thời điểm viết bài, mẫu đang được phân tích đã được Virustotal (VT) detect.</p>
            <img src="./../images/mustang-1.2.png">
            <h4 id="resource">Tài nguyên </h4>
            <p>Sau khi giải nén file .rar có 3 file được tìm thấy, tất cả đã được detect trên VT:</p>
            <img src="./../images/mustang-1.3.PNG">
            <img src="./../images/mustang-1.4.PNG">
            <img src="./../images/mustang-1.5.PNG">
            <img src="./../images/mustang-1.6.PNG">
            <h4 id="sections">Sections trong file thực thi (PE file) </h4>
            <img src="./../images/mustang-1.7.PNG">
            <p>Không có gì bất thường với các phần của tệp thực thi. Không tìm thấy sự khác biệt về kích thước bất thường hoặc tên phần bất thường.</p>
            <h4 id="imports">Imports</h4>
            <p>Phát hiện rất nhiều functions/API đã được sử dụng trong các mẫu malware, functions/API được phát hiện blacklist được sử dụng trong một số thư viện (.dll)   </p>
            <img src="./../images/mustang-1.8.PNG">

        </section>

        <section id="section2">
            <h2>Phân tích tĩnh</h2>
            <h4 id="plugx">PlugX là gì? </h4>
            <p>PlugX là một công cụ remote access tool (RAT) được một số nhóm APT sử dụng. Đây là phần mềm độc hại được nhóm APT Trung Quốc Mustang Panda lựa chọn. Trong mẫu malware của Mustang Panda mình phân tích sẽ sử dụng kỹ thuật này. </p>
            <img src="./../images/mustang-1.9.PNG">
            <p>APT Mustang Panda thường sử dụng kỹ thuật load các tệp DLL độc hại vào các ứng dụng hợp pháp trong quá trình thực thi, đây là một kỹ thuật còn được gọi là <a href="https://attack.mitre.org/techniques/T1574/001/">Hijack Execution Flow: DLL Search Order Hijacking</a>. DLL độc hại được tải vào ứng dụng hợp pháp, sau đó nó giải mã, tải và triển khai.</p>
            <h4 id="technical">Phân tích kỹ thuật </h4>
            <p>Như các bạn đã thấy, mẫu malware sau khi được giải nén, bao gồm 3 file: upservice.exe, breakpad.dll, breaklog.dat. Sau khi người dùng vô tình double click để chạy file thực thi (upservice.exe) chuyện gì sẽ xảy ra sau đó? </p>
            <p>Sau khi debug bằng IDA pro, mình đã thấy có vẻ như upservice.exe sẽ sử dụng function LoadLibraryExW để load breakpad.dll vào trong: </p>
            <img src="./../images/mustang-1.23.PNG">
            <p>Tiếp theo rằng kiểm tra xem library có tồn tại hay không? Nếu tồn tại tiếp tục sử dụng <a href="https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress">GetProcAddress</a>  và các parameters được đưa vào FARPROC GetProcAddress(
  [in] HMODULE hModule, 
  [in] LPCSTR  lpProcName); => lần lượt là Library, "SetExtraData". Vậy mình có thể hiểu trong breakpad.dll có chứa hàm hoặc variable name có tên là "SetExtraData", vậy nó sẽ làm gì trong đây?
</p>
            <img src="./../images/mustang-1.24.PNG">
            <p>Thật sự nó là một mớ hỗn độn ở đây nhưng sau tất cả mọi sự cố gắng thì mình bắt đầu thấy được hành vi tiếp theo của chúng </p>
            <p>Nó sẽ tạo folder "Up\Service Log" bằng function CreateFileW của kernelbase.dll (dll của windows):</p>
            <img src="./../images/mustang-1.10.PNG">
            <img src="./../images/mustang-1.11.PNG">
            <p>Tiếp theo mình thấy hành vi của mẫu malware này là tạo file breakpad.dll trong thư mục mới tạo ở trên. </p>
            <img src="./../images/mustang-1.12.PNG">
            <p>Sử dụng function WriteFile để ghi dữ liệu vào tập tin từ file breakpad.dll trong thư mục giải nén vào file breakpad.dll vừa tạo bằng function WriteFile của kernelbase.dll</p>
            <img src="./../images/mustang-1.13.PNG">
            <p>Tương tự với file breaklog.dat, cũng ghi dữ liệu từ giống như breakpad.dll</p>
            <img src="./../images/mustang-1.14.PNG">
            <img src="./../images/mustang-1.15.PNG">
            <p>Tương tự với file upservice.exe, cũng ghi dữ liệu từ giống như breakpad.dll</p>
            <img src="./../images/mustang-1.16.PNG">
            <p>=> Tất cả nó sẽ nằm trong thư mục C:\Windows\Up\Service Log và bạn sẽ thấy được sau khi chạy chúng. </p>
            <img src="./../images/mustang-1.17.PNG">

            <p>Mình sẽ kết hợp với việc phân tích động để tiếp tục phân tích mẫu malware này </p>
            
            


        </section>
        <section id="section4">
            <h2>Phân tích động</h2>
            <h4 id="behavior">Phân tích hành vi</h4>
            <p>Mình đã thử chạy chạy trên máy đã được cách ly để thực hiện phân tích tiếp theo hành vi của mẫu malware này (các bạn lưu ý, khi thực sự muốn phân tích hãy chuẩn bị thật kỹ môi trường và kiến thức đủ để tránh việc malware lây nhiếm trên máy). Mình monitor nó thử xem thế nào?</p>
            <p>Có vẻ như nó đã chạy lại upservice.exe với một số tham số 600 0 ... gì đó ? Mình có thể hiểu ở đây sau khi tạo folder create file và WriteFile vào C:\Windows\Up\Service Log nó đã chạy lại với tham số trên. Và có một chương trình các bạn có thể thấy nó rất bất thường? Werfault.exe??? :D userinit.exe??  :D </p>
            <img src="./../images/mustang-1.27.PNG">
            <p>Mẫu malware inject code vào chương trình Werfault.exe và vào chương trình con userinit.exe.</p>
            <h4 id="dump">Dump thử một số process</h4>
            <img src="./../images/mustang-1.20.PNG">
            <img src="./../images/mustang-1.21.PNG">
            <h4>upservice.exe -> WerFault.exe -> userinit.exe</h4>
            <img src="./../images/mustang-1.18.PNG">
            <img src="./../images/mustang-1.19.PNG">
            <p>Mình tìm thấy một số C2:</p>
            <p>45.134.83[.]4:443</p>
            <p>images.myanmarnewsonline[.]org:22</p>
            <p>images.myanmarnewsonline[.]org:80</p>
            <p>154.204.26[.]120:443</p>
            <p>update.hilifimyanmar[.]com:443</p>
            <p>update.hilifimyanmar[.]com:22</p>
            <h4 id="why">Làm sao để tồn tại? </h4>
            <p>Mình đã thấy service được tạo ra với start type: auto start? => Nó đã tự tạo ra 1 serices "Master Service Log", mỗi khi nạn nhân mở máy thì service này sẽ tự động chạy và file này trỏ đến C:\Windows\Up\Service Log\upservice.exe.
             <img src="./../images/mustang-1.28.PNG">
 </p>

        </section>
        <section id="section3">
            <h2>Kết luận</h2>
            <p>Trong suốt quá trình phân tích, mình đã cố gắng phân tích mẫu APT này nhưng sẽ rất khó hiểu nếu như các bạn chỉ đọc, nếu các bạn đi từ từ và phân tích chúng, các bạn sẽ hiểu những gì mình nói, có thể quá mới mẻ nhưng hãy tập làm quen với điều đó, từ các chuỗi được tìm thấy cho đến các giao thức liên lạc và các ứng dụng được nhắm mục tiêu. Mình xác nhận rằng phần mềm độc hại khi APT tấn công vào một tổ chức, một số anti-virus chưa thể phát hiện ra được, vì vậy trước khi thao tác vào bất cứ điều gì trên máy các bạn nên cân nhắc trước khi cài để tránh máy tính bị nhiễm malware nhé!</p>
        </section>

    </div>
    <footer>
        <p>&copy; 2023 Mai Lam Anh CyberS3c</p>
    </footer>
</body>
</html>
